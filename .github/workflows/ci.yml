name: Automação Selenium - Execução Completa
on: [push, pull_request]

jobs:
  test-on-windows:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Chrome and Driver
      shell: pwsh
      run: |
        $ProgressPreference = 'SilentlyContinue'
        # Instalação do Chrome
        Invoke-WebRequest "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile chrome_installer.exe
        Start-Process -FilePath .\chrome_installer.exe -Args "/silent /install" -Wait
        Remove-Item chrome_installer.exe
        
        # Instalação do ChromeDriver via webdriver-manager
        python -m pip install webdriver-manager

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt pytest pytest-html

    - name: Run tests and verify report
      shell: pwsh
      run: |
        # Executa os testes com configurações melhoradas para o relatório
        python -m pytest test_execution/test_fullexecution.py -v \
          --html=relatorio_teste.html \
          --self-contained-html \
          --capture=sys \
          --show-capture=log \
          --metadata=Runner-GH-Actions \
          --metadata=Python-3.9
        
        # Verifica se o arquivo foi criado
        if (-not (Test-Path "relatorio_teste.html")) {
          Write-Error "Relatório não foi gerado!"
          Get-ChildItem -Recurse | Where-Object { $_.Name -like "*.html" } | Select-Object FullName
          exit 1
        }
        
        # Renomeia para garantir o nome correto
        Copy-Item "relatorio_teste.html" "report.html" -Force

    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: relatorio-teste-completo
        path: report.html
        if-no-files-found: error